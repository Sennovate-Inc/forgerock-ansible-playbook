#################################################################
# Install ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
#################################################################
---
- name: Install ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
  block:

  # Download ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
  - name: Download ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
    get_url: 
      url: https://sennovate-downloads.s3.us-east-2.amazonaws.com/Packages/Forgerock/AccessManagement/{{ FORGEROCK_AM_VERSION }}/AM-{{ FORGEROCK_AM_VERSION }}.zip
      dest: /tmp/AM-{{ FORGEROCK_AM_VERSION }}.zip
      mode: '0444'
      force: yes
  
  # Unzip ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
  - name: Unzip ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
    unarchive:
      src: /tmp/AM-{{ FORGEROCK_AM_VERSION }}.zip
      dest: /tmp/
      remote_src: yes
  
  # Deploy ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
  - name: Deploy ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
    copy:
      src: /tmp/openam/AM-{{ FORGEROCK_AM_VERSION }}.war
      dest: /var/lib/tomcat/webapps/openam.war
      remote_src: yes
  
  rescue:

  # UnDeploy ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
  - name: UnDeploy ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - /var/lib/tomcat/webapps/openam.war
      - /var/lib/tomcat/webapps/openam
      - /usr/share/tomcat/openam
  
  - fail:
      msg: "Unable to Install ForgeRock Access Management {{ FORGEROCK_AM_VERSION }}. Rolling Back."

  always:
  
  # Clean Up ForgeRock Access Management {{ FORGEROCK_AM_VERSION }} Downloads
  - name: Clean Up ForgeRock Access Management {{ FORGEROCK_AM_VERSION }} Downloads
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - /tmp/AM-{{ FORGEROCK_AM_VERSION }}.zip
      - /tmp/openam